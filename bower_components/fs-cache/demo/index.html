<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>fs-cache demo</title>

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../es6-promise/dist/es6-promise.auto.js"></script>
    <script src="../../hf/assets/js/fs/storage.js"></script>

    <script>
      window.Polymer = {
        dom: 'shady',
        lazyRegister: true,
        useNativeCSSProperties: true
      };
    </script>

    <link rel="import" href="../../polymer/polymer.html">
    <link rel="import" href="../../iron-demo-helpers/demo-pages-shared-styles.html">
    <link rel="import" href="../../iron-demo-helpers/demo-snippet.html">
    <link rel="import" href="../../paper-button/paper-button.html">
    <link rel="import" href="../../paper-dropdown-menu/paper-dropdown-menu.html">
    <link rel="import" href="../../paper-listbox/paper-listbox.html">
    <link rel="import" href="../../paper-item/paper-item.html">
    <link rel="import" href="../fs-crypto.html">
    <link rel="import" href="../fs-cache.html">
    <link rel="import" href="../fs-cache-item.html">

    <style is="custom-style" include="demo-pages-shared-styles">
      .vertical-section-container {
        width: 100%;
        max-width: 500px;
      }
    </style>
  </head>
  <body>
    <div class="vertical-section-container centered">
      <h1>Basic fs-cache demo</h1>
      <demo-el></demo-el>

      <template is="dom-bind">
      <dom-module id="demo-el">

        <template>

          <style>
            :host {
              display: inline-block;
              box-sizing: border-box;
              width: 100%;
            }
            .returned-data {
              display: flex;
              flex-flow: column;
            }
            .paper-button {
              background-color: #3073dd;
              color: #fff;
              margin-top: 10px;
            }
            pre {
              background: #f0f0f0;
              padding: 10px;
            }
            [hidden] {
              display: none;
            }
            .current-cache {
              padding: 10px;
              border: 1px solid #ddd;
            }
          </style>

          <fs-cache store-name="demo" lifetime="hour" cache="{{demoCache}}"></fs-cache>
          <fs-cache-item cache="[[demoCache]]" key="stuff" value="{{demoStuffValue}}" error="{{errorObj}}"></fs-cache-item>
          <fs-cache-item cache="[[demoCache]]" key="things" encrypted value="{{demoThingsValue}}" error="{{errorObj}}"></fs-cache-item>

          <fs-cache store-name="demo" lifetime="day" type="session" cache="{{sessionDemoCache}}"></fs-cache>
          <fs-cache store-name="demo" lifetime="week" type="local" cache="{{localDemoCache}}"></fs-cache>

          <p class="current-cache"><b>Current DB:</b> [[_getCacheName(cache)]]</p>
          <h2>Select Store</h2>
          <div class="">
            <paper-dropdown-menu label="Cache Type" >
              <paper-listbox id="typeList" class="dropdown-content" attr-for-selected="value" selected="{{type}}">
                <paper-item role="option" value="demoCache">IndexedDB</paper-item>
                <paper-item role="option" value="sessionDemoCache">Local Storage</paper-item>
                <paper-item role="option" value="localDemoCache">Session Storage</paper-item>
              </paper-listbox>
            </paper-dropdown-menu>
          </div>
          <h2>Save/Retrieve Data</h2>
          <form on-submit="_saveToStore">
            <div class="">
              <label for="">Key</label>
              <input type="text" name="" value="{{key::input}}">
            </div>
            <div class="">
              <label for="">Value</label>
              <input type="text" name="" value="{{val::input}}">
            </div>
            <button type="submit" hidden></button>
            <div>
              <paper-button class="paper-button" on-tap="_saveToStore">Save to Store</paper-button>
              <paper-button class="paper-button" on-tap="_getValue">Get value</paper-button>
            </div>
            <div>
              <paper-button class="paper-button" on-tap="_saveToStoreEncrypted">Save to Store Encrypted</paper-button>
              <paper-button class="paper-button" on-tap="_getEncryptedValue">Get Encrypted Value</paper-button>
            </div>

          </form>

          <h2>Stored Value</h2>
          <pre>{{storedValue}}</pre>

          <h2>Save/Retrieve Through Data Binding</h2>
          <p>Type something below and then refresh the page.</p>
          <div class="">
            <label for="">Stuff</label>
            <input type="text" name="" value="{{demoStuffValue::input}}">
          </div>
          <div class="">
            <label for="">Things</label>
            <input type="text" name="" value="{{demoThingsValue::input}}">
          </div>

          <h2>Danger Zone</h2>

          <paper-button class="paper-button" on-tap="_clearCache">Clear Cache</paper-button>
          <paper-button class="paper-button" on-tap="_deleteDatabases">Delete Databases</paper-button>
        </template>

        <script>
          Polymer({
            is: 'demo-el',
            properties: {
              store: {
                type: String,
                observer: 'get'
              },
              cache: {
                type: Object
              },
              type: {
                type: String,
                value: 'demoCache'
              },
              errorObj: {
                type: Object,
                observer: '_errorHandler'
              }
            },
            observers: ['_typeObserver(type, demoCache)'],
            _getValue: function(e) {
              e.preventDefault();
              var that = this;
              var key = this.key;
              if(!key){
                return;
              }
              this.cache.getItem(key)
                .then(function(data){
                  that.set('storedValue', data);
                });

            },

            _errorHandler: function(err) {
              console.log(err);
            },

            _typeObserver: function(type, demoCache) {
              if(type && demoCache){
                this.cache = this[type];
              }
            },
            _getEncryptedValue: function(e) {
              e.preventDefault();
              var that = this;
              var key = this.key;
              if(!key){
                return;
              }
              this.cache.getEncrypted(key)
                .then(function(data){
                  that.set('storedValue', data);
                });

            },

            _saveToStore: function(e) {
              e.preventDefault();
              var key = this.key;
              var val = this.val;
              if(!key || !val){
                return;
              }

              this.cache.setItem(key, val);

            },
            _saveToStoreEncrypted: function(e) {
              e.preventDefault();
              var key = this.key;
              var val = this.val;
              if(!key || !val){
                return;
              }
              this.cache.setEncrypted(key, val);
            },
            _createStore: function(e) {
              var store = this.store;
              var type = this.type;
              var db = this.db;
              this.cache = FS.cache.instance({storeName:store, type:type, dbName:db});
            },
            _clearCache: function(e){
              FS.cache.clearAll();
            },
            _deleteDatabases: function(e){
              FS.cache.deleteAll();
            },
            _getCacheName: function(cache){
              var type = 'indexedDB';
              if(cache && cache._config){
                if(cache._config.driver === 'localStorageWrapper'){
                  type = 'localStorage';
                }
                if(cache._config.driver === 'sessionStorageWrapper'){
                  type = 'sessionStorage';
                }
                return cache._config.name + ' - ' + cache._config.storeName + ' in ' + type;
              }

              return 'No DB created.'

            }
          });
        </script>
      </dom-module>
      </template>
      <h2>Simple Web Component Usage</h2>
      <demo-snippet>
        <template>
          <fs-cache store-name="demo" type="session" lifetime="hour" cache="{{cache}}"></fs-cache>
          <button on-tap="_doThing">Do Thing</button>
          <script>
            Polymer({
              is: 'demo-test',
              _doThing: function(e){
                this.cache.setItem('thingDone', true)
                .then(function(value){
                  console.log('thingDone: '+value);
                });
              }
            });
          </script>
        </template>
      </demo-snippet>
      <h2>Simple Web Component Binding Usage</h2>
      <demo-snippet>
        <template is="dom-bind">
          <fs-cache store-name="demo" type="session" lifetime="hour" cache="{{cache}}"></fs-cache>
          <fs-cache-item cache="[[cache]]" key="stuff" value="{{demoStuffValue}}"></fs-cache-item>

          <input type="text" value="{{stuffValue::input}}">

        </template>
      </demo-snippet>
      <h2>Simple Javascript Usage</h2>
      <demo-snippet>
        <template>
          <script>
            var _cache = FS.cache.instance();


            _cache.setItem('stuff', 'things')
              .then(function(storedValue){
                console.log(storedValue);
              });

            _cache.getItem('stuff')
              .then(function(value){
                console.log(value);
              });

            _cache.clear();


          </script>
        </template>
      </demo-snippet>

      <h2>Advanced Usage</h2>
      <demo-snippet>
        <template>
          <script>
            var dbConfig = {
              dbName: 'preferences',
              type: 'session', //defaults to indexedDB. options - 'session', 'local' (storage)
              storeName: 'preferences'
            };

            var _cache = FS.cache.instance(dbConfig);

            // You can store Arrays, Objects, Strings, etc.
            _cache.setItem('stuff', {stuff: 'things'})
              .then(function(storedValue){
                console.log(storedValue);
              });

            _cache.getItem('stuff')
              .then(function(value){
                console.log(value);
              });

            var personObj = {name: 'Frank'};

            // stores an encrypted value in storage
            _cache.setEncrypted('persons', personObj)
              .then(function(storedValue){
                console.log(storedValue);
              });


            // retrieves an encrypted value in storage
            _cache.getEncrypted('persons')
              .then(function(value){
                console.log(value);
              });


          </script>
        </template>
      </demo-snippet>
    </div>
  </body>
</html>
